# Reliable FogROS2

Reliable FogROS2 is a cloud robotics platform on FogROS2-SGC for connecting disjoint ROS2 networks across different physical locations, networks, and Data Distribution Services. 


\[[Website](https://sites.google.com/view/fogros2-sgc)\] \[[Video](https://youtu.be/hVVFVGLcK0c)\] \[[Arxiv](https://arxiv.org/abs/2306.17157)\]

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
**Table of Contents**

- [Local Demo](#local-demo)
- [Build FogROS2 SGC](#build-fogros2-sgc)
  - [Install dependencies](#install-dependencies)
    - [Install Rust](#install-rust)
    - [Install ROS](#install-ros)
  - [Build the repo](#build-the-repo)
- [Run with Different Machines](#run-with-different-machines)
    - [Certificate Generation](#certificate-generation)
    - [Run ROS2 talker and listener](#run-ros2-talker-and-listener)
    - [Run with Environment Variables](#run-with-environment-variables)
- [From SGC to SGC-lite](#from-sgc-to-sgc-lite)
    - [Why Lite version](#why-lite-version)
    - [Deploying Your Own Routing Infrastructure](#deploying-your-own-routing-infrastructure)
    - [Notes on using Berkeley's Public Servers](#notes-on-using-berkeleys-public-servers)
    - [TODOs](#todos)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

#### Signaling Server 
Run signaling server by 
```
docker run --net=host -it keplerc/fogros2-rt-router:latest bash -c "cd rt-fogros2/fog_rs/fogrs-signaling && RUST_LOG=info cargo run"
```
The server will be automatically hosted at port 8000. By default, the routing records are cleaned up by 90 seconds. 

## Development Docker Setup

#### Step 0: Generate Crypto Certificate 

The certificates can be generated by 
```
cd sgc_launch/configs
./generate_crypto.sh
```
You need to make sure all the machines that you intend to connect share the same certificate. 

You can check if the certificates match by running
```
cat /fog_ws/install/sgc_launch/share/sgc_launch/configs/crypto/test_cert/test_cert-private.pem
```
The default certificate is named `test_cert`. 

#### Step 1: Build Container
Build container with the following command:
```bash
docker build -f dev.Dockerfile  --build-arg USER_ID=$(id -u) --build-arg GROUP_ID=$(id -g) --build-arg USER_NAME="$USER"  -t dev-fr .
```
then start **two** terminals, for both, run 
```bash
docker run --user $(id -u):$(id -g) -ti --net=host -v ~/rt-fogros2:/fog_ws/rt-fogros2  dev-fr bash 
```
The parameters such as user ID and group are used to make sure the built targets are readable and modifiable by the host. 

### Run Surgery Example 
```
RUST_LOG=info cargo run 
```
On each terminal, run 
```
export RUST_LOG=info && export ROS_DOMAIN_ID=3 && source install/setup.bash && ros2 launch bench surgery.publisher.launch.py
```
and 
```
export RUST_LOG=info && export ROS_DOMAIN_ID=2 && source install/setup.bash && ros2 launch bench surgery.receiver.launch.py 
```

and use cyclonedds to publish and subscribe to the topics. 

### F&Q
1. If the lisenter side is not responsive (no logs show up) when the talker launches, double check the certificate. Sometimes it gets tricky with `/r/n` and `/n` or whether the file ends with a newline character (the editor may do something stupid). Double check with 
```
od -c /fog_ws/install/sgc_launch/share/sgc_launch/configs/crypto/test_cert/test_cert-private.pem
```

2. If the listner is responsive but they don't connect, check the internet firewall rules. We require one side of the machines are connectable via UDP (LMK if you want specific ports)

3. If you want to use the default interface, you can change the `default_interface` in `fog_rs/fogrs-core/src/routing_manager.rs` to `"enp5s0"` (whatever your default interface is). This removes O^2 connection and only use the default interface(s) to connect.

4. currently signaling server is hosted at `0.0.0.0:8000`. If you want to change it, change the dvrk.yaml file in `sgc_launch/configs`. (currently it's in localhost)